---
// src/pages/cards/minor.astro
import { db } from '../../lib/firebase';
import { collection, getDocs } from 'firebase/firestore';
import Layout from '../../layouts/Layout.astro';
import '../../styles/cards.css';
// Importar utilidades compartidas
import { 
  processImageUrl, 
  getMinorArcanaOrderIndex, 
  groupCardsBySuit, 
  SUIT_ORDER, 
  SUITS,
  type MinorArcanaCard 
} from '../../utils/index.js';

interface FirestoreCard {
  id: string;
  nombre?: string;
  palo?: string;
  valor?: string;
  imagem?: string | null;
  imagen?: string | null;
}

// Query básica sin filtros complejos mientras se construye el índice
const q = collection(db, 'cards');
const querySnapshot = await getDocs(q);

const cards = querySnapshot.docs
  .map(doc => {
    const data = doc.data();
    const imageUrl = data.imagem || data.imagen;
    
    return {
      id: doc.id,
      nombre: data.nombre || 'Sin nombre',
      palo: data.palo || 'Sin palo',
      valor: data.valor || 'N/A',
      arcano: data.arcano || '',
      imagem: processImageUrl(imageUrl)
    };
  })
  .filter(card => card.arcano === 'menor');

// Agrupar cartas por palo usando la utilidad compartida
const cardsBySuit = groupCardsBySuit(cards as MinorArcanaCard[]);

// Usar el orden predefinido de palos
const orderedSuits = SUIT_ORDER.filter(suit => cardsBySuit[suit] && cardsBySuit[suit].length > 0);

const pageTitle = "Arcanos Menores del Tarot de Marsella";
const pageDescription = "Explora los cuatro palos de los arcanos menores: Bastos, Copas, Espadas y Oros";
---

<Layout title={pageTitle} description={pageDescription}>
  <main class="container mx-auto px-4 py-8 max-w-7xl">
    <header class="text-center mb-12">
      <h1 class="text-4xl font-bold text-purple-900 mb-2">{pageTitle}</h1>
      <p class="text-xl text-purple-700">Los cuatro palos: Bastos, Copas, Espadas y Oros</p>
    </header>

    <!-- Sección por cada palo -->
    {orderedSuits.map(suit => (
      <section class="mb-16">
        <h2 class="text-3xl font-semibold text-purple-800 mb-6 capitalize border-b-2 border-purple-200 pb-2">
          {suit === 'bastos' && `Bastos - El elemento ${SUITS.bastos.element}`}
          {suit === 'copas' && `Copas - El elemento ${SUITS.copas.element}`}
          {suit === 'espadas' && `Espadas - El elemento ${SUITS.espadas.element}`}
          {suit === 'oros' && `Oros - El elemento ${SUITS.oros.element}`}
        </h2>

        <!-- Grid para las cartas del palo -->
        <div class="cartas-grid-minor">
          {cardsBySuit[suit].map(card => (
            <a
              href={`/cards/${card.id}`}
              class="carta-link-minor"
            >
              <article class="carta-item-minor">
                <div class="carta-image-container-minor">
                  <img
                    src={card.imagem}
                    alt={`Carta ${card.nombre}`}
                    loading="lazy"
                    decoding="async"
                    class="carta-image-minor"
                    onerror="this.src='/placeholder-card.jpg';this.classList.add('error-image')"
                  />
                </div>
                <div class="carta-info-minor">
                  <h3 class="carta-nombre-minor">{card.nombre}</h3>
                  <span class="carta-valor-minor capitalize">{card.valor}</span>
                </div>
              </article>
            </a>
          ))}
        </div>
      </section>
    ))}
  </main>
</Layout>